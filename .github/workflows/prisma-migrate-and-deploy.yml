name: Migrate DB and Deploy to Vercel

on:
  push:
    branches:
      - main

jobs:
  migrate-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Decode DB CA (optional)
        if: ${{ secrets.DB_CA_B64 != '' }}
        env:
          DB_CA_B64: ${{ secrets.DB_CA_B64 }}
        run: |
          echo "$DB_CA_B64" | base64 --decode > /tmp/db_ca.pem
          ls -l /tmp/db_ca.pem

      - name: Apply Prisma migrations
        env:
          DATABASE_URL: ${{ secrets.LICITACOES__POSTGRES_URL }}
          NODE_EXTRA_CA_CERTS: /tmp/db_ca.pem
        run: |
          echo "Applying Prisma migrations..."
          # If your DB requires special SSL handling, add it to the DATABASE_URL secret
          npx prisma migrate deploy --schema=prisma/schema.prisma

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Triggering Vercel deploy..."
          # Install vercel CLI and deploy (assumes this repo is already linked in Vercel)
          npm i -g vercel
          npx vercel --prod --confirm --token "$VERCEL_TOKEN"
