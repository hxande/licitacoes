generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("LICITACOES__POSTGRES_PRISMA_URL")
  directUrl = env("LICITACOES__POSTGRES_URL_NON_POOLING")
}

model usuario {
  id                BigInt    @id @default(autoincrement())
  email             String    @unique
  senha_hash        String
  nome              String
  telefone          String?
  email_verificado  Boolean   @default(false)
  token_verificacao String?
  token_expira_em   DateTime?
  token_reset_senha   String?
  reset_expira_em     DateTime?
  notificacoes_email  Boolean   @default(true)
  criado_em           DateTime  @default(now())
  atualizado_em       DateTime  @default(now())
}

model sessao {
  id            String   @id
  user_id       BigInt
  token         String   @unique
  expira_em     DateTime
  criado_em     DateTime @default(now())
}

model alerta {
  id            BigInt   @id @default(autoincrement())
  user_id       BigInt
  nome          String
  filtros       Json     @default("{}")
  periodicidade String   @default("diario")
  criado_em     DateTime @default(now())
}

model favorito {
  user_id       BigInt
  licitacao_id  String
  criado_em     DateTime @default(now())

  @@id([user_id, licitacao_id])
}

model perfil_empresa {
  user_id        BigInt   @id
  dados          Json     @default("{}")
  atualizado_em  DateTime @default(now())
}

model historico_contrato {
  id                String  @id
  cnpj_orgao        String
  orgao             String
  uf                String
  municipio         String?
  objeto            String
  fornecedor_cnpj   String
  fornecedor_nome   String
  valor_contratado  Float
  data_assinatura   String?
  data_publicacao   String?
  tipo_contrato     String
  area_atuacao      String
  palavras_chave    Json
}

model pipeline {
  id              String   @id
  user_id         BigInt
  objeto          String
  orgao           String
  uf              String
  valor_estimado  Float?
  data_abertura   String?
  modalidade      String?
  cnpj_orgao      String?
  status          String?
  observacoes     String?
  criado_em       DateTime @default(now())
  atualizado_em   DateTime @default(now())
}

model checklist {
  id             String   @id
  user_id        BigInt
  titulo         String?
  licitacao_id   String?
  orgao          String?
  objeto         String?
  data_abertura  String?
  documentos     Json     @default("[]")
  criado_em      DateTime @default(now())
  atualizado_em  DateTime @default(now())
}

model log_notificacao {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  tipo       String   // 'resumo_diario'
  status     String   // 'enviado' | 'erro' | 'sem_conteudo'
  detalhes   Json?
  criado_em  DateTime @default(now())

  @@index([user_id, tipo, criado_em])
}

model notificacao {
  id           BigInt    @id @default(autoincrement())
  user_id      BigInt
  tipo         String    // 'nova_licitacao' | 'prazo_chegando'
  titulo       String
  corpo        String
  licitacao_id String?
  lida         Boolean   @default(false)
  lido_em      DateTime?
  criado_em    DateTime  @default(now())

  @@index([user_id, lida, criado_em])
  @@index([user_id, tipo, licitacao_id, criado_em])
}

// Cache de análises de IA para economizar tokens
model cache_analise_ia {
  id             String   @id @default(cuid())
  user_id        BigInt
  licitacao_id   String
  tipo_analise   String   // 'risco' | 'match' | 'mercado' | 'proposta'
  dados_entrada  Json     // Dados de entrada usados na análise (para validar cache)
  resultado      Json     // Resultado da análise da IA
  criado_em      DateTime @default(now())
  atualizado_em  DateTime @default(now())

  @@unique([user_id, licitacao_id, tipo_analise])
  @@index([user_id])
  @@index([licitacao_id])
  @@index([tipo_analise])
}
